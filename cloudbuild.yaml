steps:
  - name: 'gcr.io/$PROJECT_ID/packer'
    env:
      - PACKER_LOG=1
    args:
      - build
      - -force
      - -only=googlecompute
      - -var
      - image_name=traction-image
      - -var
      - version_suffix=-$SHORT_SHA
      - -var
      - project_id=jafudi-1558282200187
      - -var
      - image_family=jafudi-traction
      - -var
      - image_zone=us-east1-b
      - -var
      - headless=true
      - packer-desktop/ubuntu/pack-lubuntu.json

  # https://cloud.google.com/sdk/gcloud/reference/compute/images/export
  - name: 'gcr.io/cloud-builders/gcloud'
    args:
      - compute
      - images
      - export
      - --quiet
      - --destination-uri
      - gs://jafudi/ludopy.vmdk
      - --image
      - traction-image
      - --image-project
      - jafudi-1558282200187
      - --export-format
      - vmdk
      - --zone
      - europe-west3-b
timeout: 2400s
{

  "builders": [
    {
      "name": "guacamole-gateway",
      "user_data_file": "packer-desktop/builds/gateway-userdata",
      "metadata": {
        "ssh_authorized_keys": "{{user `ssh_public_key`}}"
      },
      "ssh_username": "ubuntu",
      "ssh_private_key_file": "{{user `private_key_file`}}",
      "ssh_keypair_name": "{{user `ssh_keypair_name`}}"
    },
    {
      "name": "lubuntu-desktop",
      "user_data_file": "packer-desktop/builds/desktop-userdata",
      "metadata": {
        "ssh_authorized_keys": "{{user `ssh_public_key`}}",
        "gitlab-runner-token": "{{user `gitlab_runner_token`}}"
      },
      "ssh_username": "ubuntu",
      "ssh_private_key_file": "{{user `private_key_file`}}",
      "ssh_keypair_name": "{{user `ssh_keypair_name`}}"
    }
  ],
  "provisioners": [
    {
      "only": ["lubuntu-desktop"],
      "execute_command": "echo 'ubuntu' | {{.Vars}} sudo -S -E sh -eux '{{.Path}}'",
      "scripts": [
        "{{user `script_dir`}}/desktop/lubuntu-desktop.sh",
        "{{user `script_dir`}}/desktop/lxqt-look-and-feel.sh",
        "{{user `script_dir`}}/desktop/multiple-languages.sh",
        "{{user `script_dir`}}/desktop/meteo-qt.sh",
        "{{user `script_dir`}}/desktop/podcasts-and-videos.sh",
        "{{user `script_dir`}}/desktop/resource-monitor.sh",
        "{{user `script_dir`}}/desktop/mumble-pulseaudio.sh",
        "{{user `script_dir`}}/desktop/desktop-sharing.sh",
        "{{user `script_dir`}}/desktop/edu-games.sh",
        "{{user `script_dir`}}/desktop/mindmap-notes.sh",
        "{{user `script_dir`}}/desktop/office-applications.sh"
      ],
      "type": "shell"
    },
        {
      "type": "file",
      "source": "packer-desktop/vartmp-uploads/common/",
      "destination": "/var/tmp/"
    },
    {
      "type": "file",
      "only": ["guacamole-gateway"],
      "source": "packer-desktop/vartmp-uploads/gateway/",
      "destination": "/var/tmp/"
    },
    {
      "type": "file",
      "only": ["lubuntu-desktop"],
      "source": "packer-desktop/vartmp-uploads/desktop/",
      "destination": "/var/tmp/"
    },
    {
      "type": "file",
      "only": ["guacamole-gateway"],
      "source": "packer-desktop/gateway-home-uploads/",
      "destination": "/home/ubuntu/uploads/"
    },
    {
      "type": "file",
      "only": ["lubuntu-desktop"],
      "source": "packer-desktop/desktop-home-uploads/",
      "destination": "/home/ubuntu/uploads/"
    },
    {
      "only": ["guacamole-gateway"],
      "execute_command": "echo 'ubuntu' | {{.Vars}} sudo -S -E sh -eux '{{.Path}}'",
      "scripts": [
        "{{user `script_dir`}}/gateway/motd.sh"
      ],
      "type": "shell"
    },
    {
      "environment_vars": [
        "FULLY_QUALIFIED_DOMAIN={{user `full_domain`}}"
      ],
      "execute_command": "echo 'ubuntu' | {{.Vars}} sudo -S -E sh -eux '{{.Path}}'",
      "scripts": [
        "{{user `script_dir`}}/common/before_final_reboot.sh"
      ],
      "type": "shell"
    },
    {
      "type": "shell",
      "execute_command": "echo 'ubuntu' | {{.Vars}} sudo -S -E sh -eux '{{.Path}}'",
      "inline": ["reboot"],
      "expect_disconnect": true
    },
    {
      "type": "shell",
      "execute_command": "echo 'ubuntu' | {{.Vars}} sudo -S -E sh -eux '{{.Path}}'",
      "script": "{{user `script_dir`}}/common/after_final_reboot.sh",
      "pause_before": "10s"
    }
  ]
}
